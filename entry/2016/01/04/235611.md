---
Title: パフォーマンス解析の観点
Category:
- Books
- Performance
- System Performance
Date: 2016-01-04T23:56:11+09:00
URL: http://memo.yuuk.io/entry/2016/01/04/235611
EditURL: https://blog.hatena.ne.jp/y_uuki/performance.hatenablog.jp/atom/entry/6653586347151646284
---

ボトルネック、もしくはレイテンシが支配的な処理以外を高速化しても意味がない。
高速化する価値のあるポイントを見極めるには、システムのパフォーマンス状況を把握する必要がある。
書籍 [Systems Performance](http://www.amazon.co.jp/exec/obidos/ASIN/0133390098/yuuki0b2-22/) にはシステムパフォーマンスの解析の方向性として、ワークロード解析とリソース解析の2軸があると書かれている。

<img width="595" alt="screen shot 0027-08-30 at 2 16 56" src="https://cloud.githubusercontent.com/assets/473708/9563393/3fc2301c-4ebd-11e5-861d-4f9ee1f04219.png">

ワークロード解析はアプリケーション的な視点での解析で、リソース解析はOS/ミドルウェア的な視点での解析である。
OSのソフトウェアスタックに対して、前者はトップダウン、後者はボトムアップな解析であると言える。
アプリケーション的な最適化の余地がだいたい8割でOS/ミドルウェア的な最適化の余地は2割と、Systems Performanceの著者がどこかで書いてた気がする。

リソース解析は結構得意で好きなんだけど、異常なパフォーマンス劣化を抑えることはできても、劇的にパフォーマンスがよくなったりはしない。
だいたいリソース解析から発見したボトルネックを潰すと劇的に改善できるイメージがある。

## ワークロード解析

- アクセスログ解析
- Devel::NYTProf 的なプロファイラによる解析
- pt-query-digest などによるMySQLのスローログ解析

## リソース解析

システムというのは細かくコンポーネントに分けると待ち行列が連続的に組み合わさったものだと思う (参考: [リトルの法則]( https://ja.wikipedia.org/wiki/%E3%83%AA%E3%83%88%E3%83%AB%E3%81%AE%E6%B3%95%E5%89%87) )。
例えば、リクエストを受け取ってレスポンスを返すまでを考えると、パケットを蓄積するキュー => TCPコネクションを受け付けるキュー（syn backlogと listen backlog) =>  Starletのワーカーキュー(キューじゃないけど) => MySQLのコネクションを受け付けるスレッド => MySQLのI/Oスレッド =>  ファイルシステム/ブロッグデバイスレイヤのI/Oキュー のようにいくつもの待ち行列がある。あとは全体でみてこれらの処理をスケジュールするCPUコアごとのランキューなど。

この中からtopとかdstatを使ってどの待ち行列がボトルネックを見つけるなのか見つける必要がある。
リソース解析の観点でみて、Webアプリケーションにとって理想的な状態はWebサーバのアプリケーションロジック部分のCPU時間がボトルネックである状態、ということになる。

ISUCONの場合では、やはりワークロード解析が支配的なイメージ。

[asin:0133390098:detail]
